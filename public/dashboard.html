<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>QR Studio - Dashboard</title>
  <style>
    /* ... (Keep your existing CSS) ... */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #C9FFBF 0%, #FFAFBD 100%); min-height: 100vh; }
    .top-bar { background: white; padding: 16px 40px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .logo { font-size: 24px; font-weight: 700; background: linear-gradient(135deg, #C9FFBF 0%, #FFAFBD 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; cursor: pointer; }
    .tagline { font-size: 12px; color: #6c757d; }
    .nav-links { display: flex; gap: 24px; align-items: center; }
    .nav-links a { text-decoration: none; color: #495057; font-weight: 600; font-size: 14px; cursor: pointer; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #C9FFBF 0%, #FFAFBD 100%); display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; }
    .dashboard-container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }
    .dashboard-header h1 { font-size: 32px; color: #1a1a1a; margin-bottom: 32px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 32px; }
    .stat-card { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .stat-value { font-size: 36px; font-weight: 700; color: #1a1a1a; margin-top: 10px; }
    .stat-label { font-size: 14px; color: #6c757d; }
    .chart-section { background: white; padding: 32px; border-radius: 16px; margin-bottom: 32px; }
    .chart-container { height: 300px; position: relative; }
    .qr-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px; }
    .qr-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.3s; }
    .qr-card:hover { transform: translateY(-4px); }
    .qr-image { width: 100%; height: 200px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .qr-image img { max-width: 100%; max-height: 100%; border-radius: 8px; }
    .qr-content { padding: 20px; }
    .qr-title { font-weight: 700; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .qr-url { font-size: 13px; color: #6c757d; margin-bottom: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .qr-stats { display: flex; justify-content: space-between; padding-top: 12px; border-top: 1px solid #e9ecef; }
    .create-btn { padding: 12px 24px; background: linear-gradient(135deg, #C9FFBF 0%, #FFAFBD 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="logo-section">
      <div class="logo" onclick="window.location.href='auth-complete.html'">QR Studio</div>
      <div class="tagline">Create beautiful QR codes instantly</div>
    </div>
    <div class="nav-links">
      <a href="auth-success.html">Home</a>
      <a href="#" onclick="logout()">Logout</a>
      <div class="user-section">
        <div class="user-avatar" id="navAvatar">U</div>
      </div>
    </div>
  </div>

  <div class="dashboard-container">
    <div class="dashboard-header">
      <h1 id="welcomeMsg">Welcome back! ðŸ‘‹</h1>
      <p>Here's what's happening with your QR codes today</p>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="statTotalQRs">0</div>
        <div class="stat-label">Total QR Codes</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statTotalScans">0</div>
        <div class="stat-label">Total Scans</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">Active</div>
        <div class="stat-label">Account Status</div>
      </div>
    </div>

    <div class="chart-section">
      <h2>Scan Analytics (Last 7 Days)</h2>
      <div class="chart-container">
        <canvas id="scanChart"></canvas>
      </div>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2 class="section-title">Your QR Codes</h2>
      <button class="create-btn" onclick="window.location.href='auth-success.html'">
        + Create New
      </button>
    </div>

    <div class="qr-grid" id="qrGrid">
       <p style="color:#666; padding:20px;">Loading your QR codes...</p>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script>
    // 1. AUTH CHECK
    const userJson = localStorage.getItem('qrstudio_user');
    const token = localStorage.getItem('qrstudio_token');

    if (!userJson || !token) {
      window.location.href = 'auth.html';
    }

    const user = JSON.parse(userJson);
    const firstName = user.name ? user.name.split(' ')[0] : 'User';
    
    document.getElementById('welcomeMsg').textContent = `Welcome back, ${firstName}! ðŸ‘‹`;
    document.getElementById('navAvatar').textContent = firstName.charAt(0).toUpperCase();

    // 2. LOGOUT
    function logout() {
      localStorage.clear();
      window.location.href = 'index.html';
    }

    // 3. FETCH DASHBOARD DATA
    async function loadDashboardData() {
      try {
        const res = await fetch('/api/dashboard-stats', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Failed to load stats');
        const data = await res.json();

        document.getElementById('statTotalQRs').textContent = data.totalQRs;
        document.getElementById('statTotalScans').textContent = data.totalScans;

        renderChart(data.graphData);
        renderQRList(data.qrList);

      } catch (err) {
        console.error(err);
      }
    }

    // 4. CHART
    function renderChart(dataPoints) {
      const ctx = document.getElementById('scanChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Today'],
          datasets: [{
            label: 'Scans',
            data: dataPoints,
            borderColor: '#FF6B9D',
            backgroundColor: 'rgba(255, 107, 157, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
           responsive: true,
           maintainAspectRatio: false,
           plugins: { legend: { display: false } },
           scales: { y: { beginAtZero: true } }
        }
      });
    }

    // 5. QR LIST
    function renderQRList(qrs) {
      const grid = document.getElementById('qrGrid');
      
      if (!qrs || qrs.length === 0) {
        grid.innerHTML = '<p style="padding:20px; color:#666">No QR codes yet. Create one!</p>';
        return;
      }

      grid.innerHTML = qrs.map(qr => `
        <div class="qr-card">
          <div class="qr-image">
            <img src="${qr.qrImage}" alt="QR Code">
          </div>
          <div class="qr-content">
            <div class="qr-title">${qr.title || 'Untitled'}</div>
            <div class="qr-url"><a href="${qr.targetUrl}" target="_blank" style="color:#6c757d;text-decoration:none">${qr.targetUrl}</a></div>
            <div class="qr-stats">
              <div class="qr-stat-item">
                <div class="qr-stat-value">${qr.scans}</div>
                <div class="qr-stat-label">Scans</div>
              </div>
              <div class="qr-stat-item">
                <div style="font-size:12px; font-weight:700; color:#FF6B9D; cursor:pointer;" onclick="window.open('${qr.targetUrl}', '_blank')">TEST</div>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    loadDashboardData();
  </script>
</body>
</html>